rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is an admin
    // Uses hardcoded UID list to avoid expensive get() operations
    function isAdmin() {
      return isAuthenticated() && 
             request.auth.uid in ['ssZniBNnBpchbaZyis16gNNvt9f1','ohY3Co2zYLRuNBxR9pwXHv42IMi1'];
    }
    
    // Helper function to check if user is the game creator
    function isGameCreator() {
      return isAuthenticated() && 
             resource.data.creator.userid == request.auth.uid;
    }

    // Helper function to check if user is anonymous
    function isAnonymous() {
      return isAuthenticated() && request.auth.token.firebase.sign_in_provider == 'anonymous';
    }
    
    // Helper function to check if user is updating only allowed fields on their own document
    function canUpdateOwnDocument() {
      return isAuthenticated() && 
             // Prevent changes to uid field
             request.resource.data.uid == resource.data.uid &&
             // Prevent changes to isAdmin field (both must be equal or both null/undefined)
             (request.resource.data.isAdmin == resource.data.isAdmin);
    }
    
    // Helper function to check if user is updating only the addedBy field on another user's document
    function canUpdateAddedByField() {
      return isAuthenticated() &&
             // Only allow addedBy field to be changed
             request.resource.data.diff(resource.data).affectedKeys().hasOnly(['addedBy']) &&
             // Ensure addedBy is an array
             request.resource.data.addedBy is list;
    }
    
    // Helper function to check if user is updating only the communityItems field
    function canUpdateCommunityItems() {
      let affectedKeys = request.resource.data.diff(resource.data).affectedKeys();
      // Check if only 'custom' field is being updated
      // Ensure custom.communityItems exists and is an array
      // If custom existed before, ensure only communityItems changed
      return isAuthenticated() &&
             affectedKeys.hasOnly(['custom']) &&
             'custom' in request.resource.data &&
             'communityItems' in request.resource.data.custom &&
             request.resource.data.custom.communityItems is list &&
             (!('custom' in resource.data) || 
              request.resource.data.custom.diff(resource.data.custom).affectedKeys().hasOnly(['communityItems']));
    }
    
    // Games collection
    match /games/{gameId} {
      // Anyone can read games
      allow read: if true;
      
      // Only non-anonymous authenticated users can create games
      // Creator must match authenticated user
      allow create: if isAuthenticated() && !isAnonymous() &&
                       request.resource.data.creator.userid == request.auth.uid;
      
      // Game creator or admins can update games fully
      // OR non-anonymous authenticated users can update only the custom.communityItems field
      allow update: if isGameCreator() || isAdmin() || (!isAnonymous() && canUpdateCommunityItems());
      
      // Only the game creator or admins can delete games
      allow delete: if isGameCreator() || isAdmin();
      
      // Subcollections
      match /{subcollection=**} {
        allow read: if true;
        allow write: if isGameCreator() || isAdmin();
      }
    }
    
    // Config collection - admins can read/write, Cloud Functions can read
    match /config/{configId} {
      allow read: if true; // Cloud Functions need to read admin email
      allow write: if isAdmin(); // Only admins can write
    }
    
    // Mail collection - only Cloud Functions can write (for email notifications)
    match /mail/{mailId} {
      allow read: if false;
      allow write: if false;
    }
    
    // Users collection - users can read/write their own document
    match /users/{userId} {
      // Anyone can read user documents (for public profile info)
      allow read: if true;
      
      // Users can create their own user document
      allow create: if isAuthenticated() && userId == request.auth.uid;
      
      // Users can update their own document, but with field-level restrictions
      // OR authenticated users can update only the addedBy field on other users' documents (for frenemies feature)
      allow update: if (isAuthenticated() && userId == request.auth.uid && canUpdateOwnDocument()) ||
                      (isAuthenticated() && userId != request.auth.uid && canUpdateAddedByField());
      
      // Prevent users from deleting their own documents (only admins via Cloud Functions can delete)
      allow delete: if false;
      
      // Subcollections (e.g., dailyChallengeRewards)
      match /{subcollection=**} {
        allow read: if isAuthenticated() && userId == request.auth.uid;
        allow write: if isAuthenticated() && userId == request.auth.uid;
      }
    }
    
    // GameTypes collection - admins can read/write
    match /gameTypes/{gameTypeId} {
      allow read: if true; // Anyone can read game types
      allow write: if isAdmin(); // Only admins can write
    }
    
    // Default: allow read for everything else, restrict writes
    match /{document=**} {
      allow read: if true;
      allow write: if false;
    }
  }
}